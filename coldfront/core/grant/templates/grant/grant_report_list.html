{% extends "common/base.html" %}
{% load crispy_forms_tags %}
{% load static %}
{% load humanize %}


{% block title %}
Grants Report
{% endblock %}


{% block content %}
<!-- Start Project Grants -->
<div class="card">
  <div class="card-header">
    <h4 class="d-inline"><i class="fas fa-trophy" aria-hidden="true"></i> Grants</h4>
    <a class="btn btn-success float-right" id='Export_BTN' role="button"><i class="fas fa-download" aria-hidden="true"></i> Export to CSV</a>
  </div>
  <div class="card-body">
    {% if grant_list %}
      <div class="table-responsive">
        <table id="grants-table" class="table table-hover table-sm">
          <thead>
            <tr>
              <th scope="col">Grant Title</th>
              <th scope="col">Project PI</th>
              <th scope="col">Faculty Role</th>
              <th scope="col">Grant PI</th>
              <th scope="col">Total Amount Awarded</th>
              <th scope="col">Funding Agency</th>
              <th scope="col">Grant Number</th>
              <th scope="col">Start Date</th>
              <th scope="col">End Date</th>
              <th scope="col">Percent Credit</th>
              <th scope="col">Direct Funding</th>
            </tr>
          </thead>
          <tbody>
            {% for grant in grant_list %}
              <tr>
                <td style="min-width: 400px" id='grant_id'>{{ grant.title }}</td>
                <td class="text-nowrap"><a href="{% url 'project-detail' grant.project.pk %}">{{ grant.project.pi.first_name }} {{ grant.project.pi.last_name }}</a></td>
                <td class="text-nowrap">{{ grant.role }}</td>
                <td class="text-nowrap">{{ grant.grant_pi }}</td>
                <td class="text-nowrap">{{ grant.total_amount_awarded|intcomma }}</td>
                <td class="text-nowrap">{{ grant.funding_agency }}</td>
                <td class="text-nowrap">{{ grant.grant_number }}</td>
                <td class="text-nowrap">{{ grant.grant_start|date:"M. d, Y" }}</td>
                <td class="text-nowrap">{{ grant.grant_end|date:"M. d, Y" }}</td>
                <td>{{ grant.percent_credit }}</td>
                <td>{{ grant.direct_funding|intcomma }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info" role="alert"><i class="fas fa-info-circle" aria-hidden="true"></i> There are no grants to display.</div>
    {% endif %}
  </div>
</div>
<!-- End Project Grants -->

<script>
  $("#navbar-main > ul > li.active").removeClass("active")
  $("#navbar-admin").addClass("active")
  $("#navbar-director").addClass("active")
  $("#navbar-grant-report").addClass("active")
  $(document).ready(function() {
    $('#grants-table').DataTable({
      "iDisplayLength": 50,
      "bSortClasses": false,
      "order": [[ 4, "desc" ]]
    });
    $('#grants-table').on('search.dt', function() {
    var value = $('.dataTables_filter input').val();
    console.log(value); // <-- the value
    var table=document.getElementsByTagName('table');
    var oTable = document.getElementById('grants-table');

    //gets rows of table
    var rowLength = oTable.rows.length;
    var grant_title = [];

    //loops through rows    
    for (i = 1; i < rowLength; i++){

      //gets cells of current row
      var oCells = oTable.rows.item(i).cells;

      //gets amount of cells of current row
      var cellLength = oCells.length;

      //loops through each cell in current row
      for(var j = 0; j < cellLength; j++){
          /* get your cell info here */
          var cellVal = oCells.item(j).innerHTML; 
          console.log(cellVal);
          grant_title.push(cellVal);
      }
    }
    console.log('here');
    console.log(grant_title);
    var Export_BTN= document.getElementById('Export_BTN');
}); 
var Export_BTN= document.getElementById('Export_BTN');
Export_BTN.onclick = function(){
      var table_id = document.getElementById('grants-table');
      var separator = ",";
      var rows = $("table tr:visible");
    // Construct csv
      var csv = [];
      for (var i = 0; i < rows.length; i++) {
        var row = [], cols = rows[i].querySelectorAll('td, th');
        for (var j = 0; j < cols.length; j++) {
            // Clean innertext to remove multiple spaces and jumpline (break csv)
            var data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/(\s\s)/gm, ' ')
            // Escape double-quote with double-double-quote (see https://stackoverflow.com/questions/17808511/properly-escape-a-double-quote-in-csv)
            data = data.replace(/"/g, '""');
            // Push escaped string
            row.push('"' + data + '"');
        }
         csv.push(row.join(separator));
        }
      var csv_string = csv.join('\n');
      // Download it
      var filename = 'export_' + table_id + '_' + new Date().toLocaleDateString() + '.csv';
      var link = document.createElement('a');
      link.style.display = 'none';
      link.setAttribute('target', '_blank');
      link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv_string));
      link.setAttribute('download', filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link)
    };
  });

  function download_csv(csv, filename) {
    var csvFile;
    var downloadLink;

    // CSV FILE
    csvFile = new Blob([csv], {type: "text/csv"});

    // Download link
    downloadLink = document.createElement("a");

    // File name
    downloadLink.download = filename;

    // We have to create a link to the file
    downloadLink.href = window.URL.createObjectURL(csvFile);

    // Make sure that the link is not displayed
    downloadLink.style.display = "none";

    // Add the link to your DOM
    document.body.appendChild(downloadLink);

    // Lanzamos
    downloadLink.click();
}

  function setCook(name, value) {
    var cookie = [
        name,
        '=',
        JSON.stringify(value)
    ].join('');
    document.cookie = cookie;
}
</script>
{% endblock %}
